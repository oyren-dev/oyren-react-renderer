{"version":3,"file":"index.js","sources":["../src/transform.ts","../src/utils.ts","../src/Runner.ts","../src/useRunner.ts"],"sourcesContent":["import { transform as _transform } from 'sucrase'\n\nexport const transform = (code: string) => {\n  return _transform(code, {\n    transforms: ['jsx', 'typescript', 'imports'],\n    production: true,\n  }).code.substring(13) // remove leading `\"use strict\";`\n}\n\nconst firstStatementRegexp =\n  /^(\\s*)(<[^>]*>|function[(\\s]|\\(\\)[\\s=]|class\\s)(.*)/\n\nexport const normalizeCode = (code: string) => {\n  return code.replace(firstStatementRegexp, '$1export default $2$3')\n}\n","import React, { createElement, isValidElement, ReactElement } from 'react'\n\nimport { transform, normalizeCode } from './transform'\nimport { RunnerOptions, Scope } from './types'\n\nconst evalCode = (code: string, scope: Scope) => {\n  // `default` is not allowed in `new Function`\n  const { default: _, import: imports, ...rest } = scope\n  const finalScope: Scope = { React, require: createRequire(imports), ...rest }\n  const scopeKeys = Object.keys(finalScope)\n  const scopeValues = scopeKeys.map((key) => finalScope[key])\n  // eslint-disable-next-line no-new-func\n  const fn = new Function(...scopeKeys, code)\n  return fn(...scopeValues)\n}\n\nexport const generateElement = (\n  options: RunnerOptions\n): ReactElement | null => {\n  const { code, scope } = options\n\n  if (!code.trim()) return null\n\n  const exports: Scope = {}\n  const render = (value: unknown) => {\n    exports.default = value\n  }\n  evalCode(transform(normalizeCode(code)), { render, ...scope, exports })\n\n  const result = exports.default\n  if (!result) return null\n  if (isValidElement(result)) return result\n  if (typeof result === 'function') return createElement(result)\n  if (typeof result === 'string') {\n    return result as unknown as ReactElement\n  }\n  return null\n}\n\nexport const createRequire =\n  (imports: Scope = {}) =>\n  (module: string): Scope => {\n    if (!imports.hasOwnProperty(module)) {\n      throw new Error(`Module not found: '${module}'`)\n    }\n    return imports[module]\n  }\n\nexport const importCode = (code: string, scope?: Scope) => {\n  const exports: Scope = {}\n  evalCode(transform(code), { ...scope, exports })\n\n  return exports\n}\n","import { Component, ReactElement } from 'react'\n\nimport { generateElement } from './utils'\nimport { RunnerOptions, Scope } from './types'\n\nexport type RunnerProps = RunnerOptions & {\n  /** callback on code be rendered, returns error message when code is invalid */\n  onRendered?: (error?: Error) => void\n}\n\ntype RunnerState = {\n  element: ReactElement | null\n  error: Error | null\n  prevCode: string | null\n  prevScope: Scope | undefined\n}\n\nexport class Runner extends Component<RunnerProps, RunnerState> {\n  state: RunnerState = {\n    element: null,\n    error: null,\n    prevCode: null,\n    prevScope: undefined,\n  }\n\n  static getDerivedStateFromProps(\n    props: RunnerProps,\n    state: RunnerState\n  ): Partial<RunnerState> | null {\n    // only regenerate on code/scope change\n    if (state.prevCode === props.code && state.prevScope === props.scope) {\n      return null\n    }\n\n    try {\n      return {\n        element: generateElement(props),\n        error: null,\n        prevCode: props.code,\n        prevScope: props.scope,\n      }\n    } catch (error: unknown) {\n      return {\n        element: null,\n        error: error as Error,\n        prevCode: props.code,\n        prevScope: props.scope,\n      }\n    }\n  }\n\n  static getDerivedStateFromError(error: Error): Partial<RunnerState> {\n    return { error }\n  }\n\n  componentDidMount() {\n    this.props.onRendered?.(this.state.error || undefined)\n  }\n\n  shouldComponentUpdate(nextProps: RunnerProps, nextState: RunnerState) {\n    return (\n      nextProps.code !== this.props.code ||\n      nextProps.scope !== this.props.scope ||\n      nextState.error !== this.state.error\n    )\n  }\n\n  componentDidUpdate() {\n    this.props.onRendered?.(this.state.error || undefined)\n  }\n\n  render() {\n    return this.state.error ? null : this.state.element\n  }\n}\n","import { useState, useRef, useEffect, createElement, ReactElement } from 'react'\n\nimport { Runner } from './Runner'\nimport { RunnerOptions } from './types'\n\nexport type UseRunnerProps = RunnerOptions & {\n  /** whether to cache previous element when error occurs with current code */\n  disableCache?: boolean\n}\n\nexport type UseRunnerReturn = {\n  element: ReactElement | null\n  error: string | null\n}\n\nexport const useRunner = ({\n  code,\n  scope,\n  disableCache,\n}: UseRunnerProps): UseRunnerReturn => {\n  const isMountRef = useRef(true)\n  const elementRef = useRef<ReactElement | null>(null)\n\n  const [state, setState] = useState<UseRunnerReturn>(() => {\n    const element = createElement(Runner, {\n      code,\n      scope,\n      onRendered: (error) => {\n        if (error) {\n          setState({\n            element: disableCache ? null : elementRef.current,\n            error: error.toString(),\n          })\n        } else {\n          elementRef.current = element\n        }\n      },\n    })\n    return { element, error: null }\n  })\n\n  useEffect(() => {\n    if (isMountRef.current) {\n      isMountRef.current = false\n      return\n    }\n\n    const element = createElement(Runner, {\n      code,\n      scope,\n      onRendered: (error) => {\n        if (error) {\n          setState({\n            element: disableCache ? null : elementRef.current,\n            error: error.toString(),\n          })\n        } else {\n          elementRef.current = element\n        }\n      },\n    })\n    setState({ element, error: null })\n  }, [code, scope, disableCache])\n\n  return state\n}\n"],"names":["transform","code","_transform","transforms","production","substring","firstStatementRegexp","_excluded","evalCode","scope","import","imports","rest","_objectWithoutPropertiesLoose","finalScope","_extends","React","require","createRequire","scopeKeys","Object","keys","scopeValues","map","key","Function","fn","generateElement","options","trim","exports","replace","normalizeCode","render","value","default","result","isValidElement","createElement","module","hasOwnProperty","Error","Runner","Component","state","element","error","prevCode","prevScope","undefined","static","props","componentDidMount","_this$props$onRendere","_this$props","this","onRendered","call","shouldComponentUpdate","nextProps","nextState","componentDidUpdate","_this$props$onRendere2","_this$props2","_ref","disableCache","isMountRef","useRef","elementRef","setState","useState","current","toString","useEffect"],"mappings":"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"}